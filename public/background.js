"use strict";function t(t){chrome.storage.sync.get(["wishlist"],(({wishlist:e})=>{e&&e.items?t(e):t({items:[],lastUpdated:null,sortBy:"title",sortOrder:"asc"})}))}async function e(e,s=!1){return await new Promise((n=>{s?t((t=>{chrome.storage.sync.set({wishlist:Object.assign(Object.assign({},t),e)},(()=>{n()}))})):chrome.storage.sync.set({wishlist:e},(()=>{n()}))}))}chrome.alarms.create("wishlistPoll",{periodInMinutes:60}),chrome.alarms.onAlarm.addListener((async function(){return await new Promise((s=>{t((t=>{if(0===t.items.length)return s();(async function(t){return await new Promise(((e,s)=>{chrome.storage.sync.get(["locale"],(async function({locale:n}){const a=n.country||"US",i=n.lang||"en";try{const s=await fetch(`https://api.ec.nintendo.com/v1/price?country=${a.toUpperCase()}&lang=${i}&ids=${t}`),n=await s.json();e(n.prices)}catch(t){s(t)}}))}))})(t.items.reduce(((t,e)=>t+`${""===t?"":","}${e.titleId}`),"")).then((n=>{const a=t.items.map((t=>{const{discount_price:e,regular_price:s}=n.find((e=>e.title_id===t.titleId));return Object.assign(Object.assign({},t),{price:e?e.amount:s.amount,ogPrice:e?s.amount:"",saleEnds:e?`Sale ends ${new Date(e.end_datetime).toLocaleString()}`:"",outdated:!1})})),i={items:a,lastUpdated:Date.now()};!function(t){const e=t.reduce(((t,e)=>e.ogPrice?t+1:t),0);chrome.action.setBadgeText({text:e?`${e}`:""}),chrome.action.setBadgeBackgroundColor({color:"#e60012"})}(a),e(i,!0).then(s)})).catch((n=>{console.log("Data refresh error: ",n);e({items:t.items.map((t=>Object.assign(Object.assign({},t),{outdated:!0}))),lastUpdated:Date.now()},!0).then(s)}))}))}))}));
