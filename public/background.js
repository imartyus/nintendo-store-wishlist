"use strict";function e(e){chrome.storage.sync.get(["wishlist"],(({wishlist:t})=>{t&&t.items?e(t):e({items:[],lastUpdated:null,sortBy:"title",sortOrder:"asc"})}))}async function t(e){try{const t=await fetch(e),n=function(e){const t=document.createElement("template");return e=e.trim(),t.innerHTML=e,t.content.cloneNode(!0)}(await t.text()),r=n.querySelector(".buy-now-link"),o=n.querySelector("h1"),c=parseInt(r.href.split("?title=")[1]),{discount_price:s,regular_price:a}=await function(e){return new Promise(((t,n)=>{chrome.storage.sync.get(["locale"],(async function({locale:r}){const o=r.country||"US",c=r.lang||"en";try{const n=await fetch(`https://api.ec.nintendo.com/v1/price?country=${o}&lang=${c}&ids=${e}`),r=await n.json(),{discount_price:s,regular_price:a}=(null==r?void 0:r.prices[0])||{};t({discount_price:s,regular_price:a})}catch(e){n(e)}}))}))}(c);try{return{title:o.innerText.trim(),price:s?s.amount:a.amount,ogPrice:s?a.amount:"",saleEnds:s?`Expires on ${new Date(s.end_datetime).toLocaleString()}`:"",url:e,titleId:c}}catch(t){throw new Error(`Could not parse response from ${e}`)}}catch(e){throw e}}let n;chrome.storage.sync.get(["locale"],(function({locale:e}){n=e||{}})),chrome.alarms.create("wishlistPoll",{periodInMinutes:60}),chrome.alarms.onAlarm.addListener((function(){return new Promise((n=>{e((r=>{if(!r.items.length)return n();const o=r.items.map((e=>t(e.url)));Promise.allSettled(o).then((t=>{const o=r.items.map((e=>{const n=t.find((t=>"fulfilled"===t.status&&t.value.url===e.url));return n?n.value:Object.assign(Object.assign({},e),{outdated:!0})})),c={items:o,lastUpdated:Date.now()};!function(e){const t=e.reduce(((e,t)=>t.ogPrice?e+1:e),0);chrome.action.setBadgeText({text:t?`${t}`:""}),chrome.action.setBadgeBackgroundColor({color:"#e60012"})}(o),function(t,n=!1){return new Promise((r=>{n?e((e=>{chrome.storage.sync.set({wishlist:Object.assign(Object.assign({},e),t)},(()=>{r()}))})):chrome.storage.sync.set({wishlist:t},(()=>{r()}))}))}(c,!0).then(n)})).catch((e=>{console.log("Data refresh error: ",e),n()}))}))}))}));chrome.webRequest.onCompleted.addListener((function(e){const t=new URL(e.url),r=t.searchParams.get("country"),o=t.searchParams.get("lang");n&&n.country===r&&n.lang===o||chrome.storage.sync.set({locale:{country:r,lang:o}})}),{urls:["https://api.ec.nintendo.com/v1/price?*"]});
